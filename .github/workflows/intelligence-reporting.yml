name: Publish Daily INTEL (PR Based)

on:
  schedule:
    - cron: '30 16 * * 6' # 10:00 PM IST
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch INTEL from Google Sheet and create file
        run: |
          SHEET_ID="10XfvJKDluB0Ese2uligODdSFX6GX60EgHQfmvFM0LBM"

          INTEL_TEXT=$(curl -s "https://docs.google.com/spreadsheets/d/$SHEET_ID/gviz/tq?tqx=out:csv&range=B2" | tr -d '\r')

          if [ -z "$INTEL_TEXT" ]; then
            echo "INTEL empty. Exiting."
            exit 0
          fi

          DATE=$(date +'%Y-%m-%d')
          YEAR=$(date +'%Y')
          MONTH=$(date +'%m')

          mkdir -p logs/$YEAR/$MONTH

          printf "%s\n" \
          "# INTEL Entry — $DATE" \
          "" \
          "Entity: NHE-02 (Project Siti)" \
          "Mode: Observational Intel" \
          "Human Oversight: Enabled" \
          "" \
          "---" \
          "" \
          "$INTEL_TEXT" \
          "" \
          "---" \
          "Generated via governed automation." \
          > logs/$YEAR/$MONTH/$DATE.md

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: INTEL-entry-${{ github.run_id }}
          title: "Daily INTEL Entry — ${{ github.run_started_at }}"
          body: |
            Automated daily INTEL entry generated from Google Sheets.

            - Source: Cell B2
            - Entity: NHE-02 (Project Siti)
            - Human Oversight: Required before merge
          commit-message: "Add INTEL entry for today"
          delete-branch: true
